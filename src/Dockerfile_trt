FROM nvcr.io/nvidia/tensorrt:23.05-py3

ENV LC_ALL=C.UTF-8
ENV LANG=C.UTF-8
ENV PIP_INSTALL="python -m pip --no-cache-dir install --upgrade"

# Install required system libraries
RUN apt-get update &&\
    apt-get install -y \
        libgl1-mesa-glx \
        protobuf-compiler \
        libprotoc-dev \
        libb64-0d \
        libturbojpeg \
        python3-opencv \
        ffmpeg &&\
    rm -rf /var/lib/apt/lists/*

# Copy Python dependencies and install them
COPY src/requirements.txt requirements.txt
RUN $PIP_INSTALL -r requirements.txt
RUN $PIP_INSTALL cupy-cuda12x pynvjpeg

# Copy app code
COPY src/api_trt api_trt

# Set the container startup command to launch FastAPI
CMD ["python3", "api_trt/webserver.py"]